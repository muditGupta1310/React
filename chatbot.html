<!DOCTYPE html>
<html>

<head>
    <title>React Basics</title>
</head>

<body>
    <div class="js-container"></div>

    <script src="react-basics.js"></script>

    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>
    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>
    <script src="https://unpkg.com/supersimpledev/babel.js"></script>

    <script type="text/babel">
        function ChatInput({chatMessages, setChatMessages}) {

            const [inputText, setInputText] = React.useState('');

            const [isLoading, setIsLoading] = React.useState(false);


            function handleKeyDown(event) {
                if (event.key === 'Enter') {
                    SendMessage();
                } else if (event.key === 'Escape') {
                    setInputText('');
                }
            }

            function saveInputText(event) {
                setInputText(event.target.value)
            }

            // async function SendMessage() {

            //     setInputText('')

            //     const newChatMessages = [
            //         ...chatMessages,
            //         {
            //             message:inputText,
            //             sender:'user',
            //             id:crypto.randomUUID()
            //         }
            //     ]
            //     // setChatMessages(newChatMessages);   
            //     setChatMessages([
            //         ...newChatMessages,
            //             {
            //             message:'Loading',
            //             sender:'robot',
            //             id:crypto.randomUUID()
                    
            //         }
            //     ])

            //     const response = await Chatbot.getResponseAsync(inputText);

            //     setChatMessages([
            //         ...newChatMessages,
            //         {
            //             message:response,
            //             sender:'robot',
            //             id:crypto.randomUUID()
            //         }
            //     ])           
                
            // }

            async function SendMessage() {
                if (isLoading || inputText === "") {
                    setInputText('')
                    return;
                }

                setIsLoading(true);
                

                const newChatMessages = [
                    ...chatMessages,
                    {
                        message:inputText,
                        sender:'user',
                        id:crypto.randomUUID()
                    },
                    {
                        message:'Loading',
                        sender:'robot',
                        id:crypto.randomUUID()
                    
                    }
                ]
                setChatMessages(newChatMessages);   

                setInputText('')
             

                const response = await Chatbot.getResponseAsync(inputText);

                setChatMessages([
                    ...newChatMessages.slice(0, newChatMessages.length -1),
                    {
                        message:response,
                        sender:'robot',
                        id:crypto.randomUUID()
                    }
                ])           

                setIsLoading(false)
                
            }

            return (
                <>
                    <input
                        placeholder="Send a message to Chatbot"
                        size="30"
                        value={inputText}
                        onChange={saveInputText}
                        onKeyDown = {handleKeyDown}
                    
                    />
                    <button
                        onClick={SendMessage}>
                        Send
                    </button>
                </>
            );
        }

        function ChatMessage({ message, sender }) {

            // const message = props.message;
            // const sender = props.sender;

            // const { message, sender } = props;
            /*
            if (sender === 'robot') {
                return (
                <div>
                    <img src="/images/robot.png" width="50"  />
                    {message}
                </div>
            );  
            }
            */

            return (
                <div>
                    {sender === 'robot' && (
                        <img src="/images/robot.png" width="50" />
                    )}
                    {message} 
                    {sender === 'user' && (
                        <img src="/images/user.png" width="50" />
                    )}
                </div>
            );
        }

        function ChatMessages({chatMessages}) {
            // const array = React.useState([{
            //     message: 'hello chatbot',
            //     sender: 'user',
            //     id: 'id1'
            // },
            // {
            //     message: 'Hello! How can I help you?',
            //     sender: 'robot',
            //     id: 'id2'
            // },
            // {
            //     message: 'Can you get me todays date?',
            //     sender: 'user',
            //     id: 'id3'
            // },
            // {
            //     message: 'Today is September 27',
            //     sender: 'robot',
            //     id: 'id4'
            // }]);
            // const [chatMessages, setChatMessages] = array;
            // const chatMessages = array[0];
            // const setChatMessages = array[1];

            
            return (
                <>
                    {chatMessages.map((chatMessage) => {
                        return (
                            <ChatMessage
                                message={chatMessage.message}
                                sender={chatMessage.sender}
                                key={chatMessage.id}
                            />
                        )
                    })
                    }
                </>)

        }

        function App() {

            const [chatMessages, setChatMessages] = React.useState([{
                message: 'hello chatbot',
                sender: 'user',
                id: 'id1'
            },
            {
                message: 'Hello! How can I help you?',
                sender: 'robot',
                id: 'id2'
            },
            {
                message: 'Can you get me todays date?',
                sender: 'user',
                id: 'id3'
            },
            {
                message: 'Today is September 27',
                sender: 'robot',
                id: 'id4'
            }]);

            // const ChatMessageComponents = 

            return (
                <>
                    <ChatInput 
                        chatMessages = {chatMessages}
                        setChatMessages = {setChatMessages}
                    />
                    <ChatMessages 
                        chatMessages = {chatMessages}
                    />


                </>
            );
        }

        const container = document.querySelector('.js-container');
        ReactDOM.createRoot(container).render(<App />);
    </script>
</body>

</html>